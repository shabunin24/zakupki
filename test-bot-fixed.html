<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –±–æ—Ç–∞ –ì–æ—Å–ó–∞–∫—É–ø–∫–∏</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .test-container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .warning { background: #fff3cd; border-color: #ffeaa7; }
        .test-button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .test-button:hover { background: #0056b3; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 4px; font-family: monospace; }
        .test-result.success { background: #d4edda; color: #155724; }
        .test-result.error { background: #f8d7da; color: #721c24; }
        .test-result.warning { background: #fff3cd; color: #856404; }
        .log-output { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 15px; margin: 10px 0; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ –¢–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –±–æ—Ç–∞ –ì–æ—Å–ó–∞–∫—É–ø–∫–∏</h1>
        
        <div class="test-section">
            <h3>üîß –¢–µ—Å—Ç 1: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è</h3>
            <button class="test-button" onclick="testInitialization()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é</button>
            <div id="initTest"></div>
        </div>
        
        <div class="test-section">
            <h3>üîç –¢–µ—Å—Ç 2: –ü–æ–∏—Å–∫</h3>
            <input type="text" id="searchInput" placeholder="–í–≤–µ–¥–∏—Ç–µ '–∫—Ä–∞—Å–∫–∞' –¥–ª—è —Ç–µ—Å—Ç–∞" style="padding: 8px; margin-right: 10px; width: 200px;">
            <button class="test-button" onclick="testSearch()">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∏—Å–∫</button>
            <div id="searchTest"></div>
        </div>
        
        <div class="test-section">
            <h3>üè† –¢–µ—Å—Ç 3: –í–∫–ª–∞–¥–∫–∏</h3>
            <button class="test-button" onclick="testTab('home')">üè† –ì–ª–∞–≤–Ω–∞—è</button>
            <button class="test-button" onclick="testTab('search')">üîç –ü–æ–∏—Å–∫</button>
            <button class="test-button" onclick="testTab('favorites')">‚≠ê –ò–∑–±—Ä–∞–Ω–Ω–æ–µ</button>
            <button class="test-button" onclick="testTab('profile')">üë§ –ü—Ä–æ—Ñ–∏–ª—å</button>
            <div id="tabTest"></div>
        </div>
        
        <div class="test-section">
            <h3>‚≠ê –¢–µ—Å—Ç 4: –ò–∑–±—Ä–∞–Ω–Ω–æ–µ</h3>
            <button class="test-button" onclick="testFavorites()">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑–±—Ä–∞–Ω–Ω–æ–µ</button>
            <div id="favoritesTest"></div>
        </div>
        
        <div class="test-section">
            <h3>üì± –¢–µ—Å—Ç 5: Telegram Web App</h3>
            <button class="test-button" onclick="testTelegram()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å Telegram API</button>
            <div id="telegramTest"></div>
        </div>
        
        <div class="test-section">
            <h3>üö® –õ–æ–≥ –æ—à–∏–±–æ–∫</h3>
            <button class="test-button" onclick="clearLog()">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
            <div id="errorLog" class="log-output">–õ–æ–≥ –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω –∑–¥–µ—Å—å...</div>
        </div>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="config.js"></script>
    <script src="script.js"></script>
    
    <script>
        let errorLog = [];
        
        // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –æ—à–∏–±–∫–∏
        const originalError = console.error;
        const originalWarn = console.warn;
        const originalLog = console.log;
        
        console.error = function(...args) {
            const message = args.map(arg => String(arg)).join(' ');
            errorLog.push({ type: 'error', message, timestamp: new Date().toISOString() });
            originalError.apply(console, args);
            updateErrorLog();
        };
        
        console.warn = function(...args) {
            const message = args.map(arg => String(arg)).join(' ');
            errorLog.push({ type: 'warn', message, timestamp: new Date().toISOString() });
            originalWarn.apply(console, args);
            updateErrorLog();
        };
        
        console.log = function(...args) {
            const message = args.map(arg => String(arg)).join(' ');
            if (message.includes('‚úÖ') || message.includes('‚ùå') || message.includes('‚ö†Ô∏è')) {
                errorLog.push({ type: 'log', message, timestamp: new Date().toISOString() });
                updateErrorLog();
            }
            originalLog.apply(console, args);
        };
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∞ –æ—à–∏–±–æ–∫
        function updateErrorLog() {
            const logContainer = document.getElementById('errorLog');
            if (!logContainer) return;
            
            let html = '';
            errorLog.slice(-20).forEach(entry => {
                const icon = entry.type === 'error' ? '‚ùå' : entry.type === 'warn' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
                const color = entry.type === 'error' ? '#f8d7da' : entry.type === 'warn' ? '#fff3cd' : '#d1ecf1';
                html += `<div style="background: ${color}; padding: 5px; margin: 2px 0; border-radius: 3px;">`;
                html += `${icon} ${entry.timestamp}: ${entry.message}`;
                html += '</div>';
            });
            
            logContainer.innerHTML = html;
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–∞
        function clearLog() {
            errorLog = [];
            updateErrorLog();
        }
        
        // –¢–µ—Å—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        function testInitialization() {
            const initTest = document.getElementById('initTest');
            let html = '<h4>–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:</h4>';
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
            const variables = [
                { name: 'mockPurchases', value: typeof mockPurchases !== 'undefined' ? mockPurchases.length : '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω' },
                { name: 'favorites', value: typeof favorites !== 'undefined' ? favorites.length : '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω' },
                { name: 'userApplications', value: typeof userApplications !== 'undefined' ? userApplications.length : '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω' },
                { name: 'searchHistory', value: typeof searchHistory !== 'undefined' ? searchHistory.length : '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω' }
            ];
            
            variables.forEach(variable => {
                if (variable.value !== '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω') {
                    html += `<div class="test-result success">‚úÖ ${variable.name}: ${variable.value}</div>`;
                } else {
                    html += `<div class="test-result error">‚ùå ${variable.name}: ${variable.value}</div>`;
                }
            });
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
            const functions = [
                'switchTab',
                'searchPurchases',
                'addToFavorites',
                'performSearch'
            ];
            
            let functionCount = 0;
            functions.forEach(funcName => {
                if (typeof window[funcName] === 'function') {
                    html += `<div class="test-result success">‚úÖ ${funcName}: —Ñ—É–Ω–∫—Ü–∏—è –Ω–∞–π–¥–µ–Ω–∞</div>`;
                    functionCount++;
                } else {
                    html += `<div class="test-result error">‚ùå ${funcName}: —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</div>`;
                }
            });
            
            html += `<div class="test-result ${functionCount === functions.length ? 'success' : 'error'}">`;
            html += `üìä –†–µ–∑—É–ª—å—Ç–∞—Ç: ${functionCount}/${functions.length} —Ñ—É–Ω–∫—Ü–∏–π –Ω–∞–π–¥–µ–Ω–æ`;
            html += '</div>';
            
            initTest.innerHTML = html;
        }
        
        // –¢–µ—Å—Ç –ø–æ–∏—Å–∫–∞
        function testSearch() {
            const searchTest = document.getElementById('searchTest');
            const query = document.getElementById('searchInput').value.trim();
            
            if (!query) {
                searchTest.innerHTML = '<div class="test-result warning">‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å</div>';
                return;
            }
            
            let html = `<h4>–¢–µ—Å—Ç –ø–æ–∏—Å–∫–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É "${query}":</h4>`;
            
            try {
                if (typeof searchPurchases === 'function') {
                    const results = searchPurchases(query, {});
                    html += `<div class="test-result success">‚úÖ –ü–æ–∏—Å–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ</div>`;
                    html += `<div class="test-result success">üîç –ù–∞–π–¥–µ–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: ${results.length}</div>`;
                    
                    if (results.length > 0) {
                        html += '<h5>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:</h5>';
                        results.slice(0, 3).forEach(result => {
                            html += `<div style="background: #f8f9fa; padding: 10px; margin: 5px 0; border-radius: 4px;">`;
                            html += `<strong>${result.title}</strong><br>`;
                            html += `${result.category} ‚Ä¢ ${result.region} ‚Ä¢ ${result.price.toLocaleString()} ‚ÇΩ`;
                            html += '</div>';
                        });
                    }
                } else {
                    html += '<div class="test-result error">‚ùå –§—É–Ω–∫—Ü–∏—è searchPurchases –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</div>';
                }
            } catch (error) {
                html += `<div class="test-result error">‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: ${error.message}</div>`;
            }
            
            searchTest.innerHTML = html;
        }
        
        // –¢–µ—Å—Ç –≤–∫–ª–∞–¥–æ–∫
        function testTab(tabName) {
            const tabTest = document.getElementById('tabTest');
            let html = `<h4>–¢–µ—Å—Ç –≤–∫–ª–∞–¥–∫–∏ "${tabName}":</h4>`;
            
            try {
                if (typeof switchTab === 'function') {
                    switchTab(tabName);
                    html += `<div class="test-result success">‚úÖ –í–∫–ª–∞–¥–∫–∞ "${tabName}" –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ</div>`;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–Ω—Ç–µ–Ω—Ç –≤–∫–ª–∞–¥–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è
                    const tabContent = document.getElementById(tabName + 'Content');
                    if (tabContent) {
                        html += `<div class="test-result success">‚úÖ –ö–æ–Ω—Ç–µ–Ω—Ç –≤–∫–ª–∞–¥–∫–∏ –Ω–∞–π–¥–µ–Ω</div>`;
                    } else {
                        html += `<div class="test-result warning">‚ö†Ô∏è –ö–æ–Ω—Ç–µ–Ω—Ç –≤–∫–ª–∞–¥–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω</div>`;
                    }
                } else {
                    html += '<div class="test-result error">‚ùå –§—É–Ω–∫—Ü–∏—è switchTab –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</div>';
                }
            } catch (error) {
                html += `<div class="test-result error">‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∫–ª–∞–¥–∫–∏: ${error.message}</div>`;
            }
            
            tabTest.innerHTML = html;
        }
        
        // –¢–µ—Å—Ç –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
        function testFavorites() {
            const favoritesTest = document.getElementById('favoritesTest');
            let html = '<h4>–¢–µ—Å—Ç –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ:</h4>';
            
            try {
                if (typeof addToFavorites === 'function') {
                    // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—É—é –∑–∞–∫—É–ø–∫—É –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
                    addToFavorites(1);
                    html += '<div class="test-result success">‚úÖ –ó–∞–∫—É–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ</div>';
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö
                    const favoritesCount = favorites ? favorites.length : 0;
                    html += `<div class="test-result success">‚≠ê –í –∏–∑–±—Ä–∞–Ω–Ω–æ–º: ${favoritesCount} –∑–∞–∫—É–ø–æ–∫</div>`;
                    
                    if (favoritesCount > 0) {
                        html += '<h5>–ò–∑–±—Ä–∞–Ω–Ω—ã–µ –∑–∞–∫—É–ø–∫–∏:</h5>';
                        favorites.forEach(id => {
                            const purchase = mockPurchases.find(p => p.id === id);
                            if (purchase) {
                                html += `<div style="background: #f8f9fa; padding: 10px; margin: 5px 0; border-radius: 4px;">`;
                                html += `<strong>${purchase.title}</strong> (ID: ${purchase.id})`;
                                html += '</div>';
                            }
                        });
                    }
                } else {
                    html += '<div class="test-result error">‚ùå –§—É–Ω–∫—Ü–∏—è addToFavorites –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</div>';
                }
            } catch (error) {
                html += `<div class="test-result error">‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ: ${error.message}</div>`;
            }
            
            favoritesTest.innerHTML = html;
        }
        
        // –¢–µ—Å—Ç Telegram Web App
        function testTelegram() {
            const telegramTest = document.getElementById('telegramTest');
            let html = '<h4>–¢–µ—Å—Ç Telegram Web App:</h4>';
            
            if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
                try {
                    const tg = Telegram.WebApp;
                    html += '<div class="test-result success">‚úÖ Telegram Web App API –¥–æ—Å—Ç—É–ø–µ–Ω</div>';
                    html += `<div class="test-result success">üì± –í–µ—Ä—Å–∏—è: ${tg.version || '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞'}</div>`;
                    html += `<div class="test-result success">üåê –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞: ${tg.platform || '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞'}</div>`;
                    
                    // –¢–µ—Å—Ç–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã
                    try {
                        tg.ready();
                        html += '<div class="test-result success">‚úÖ tg.ready() –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ</div>';
                    } catch (error) {
                        html += `<div class="test-result warning">‚ö†Ô∏è tg.ready() –æ—à–∏–±–∫–∞: ${error.message}</div>`;
                    }
                    
                    try {
                        tg.expand();
                        html += '<div class="test-result success">‚úÖ tg.expand() –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ</div>';
                    } catch (error) {
                        html += `<div class="test-result warning">‚ö†Ô∏è tg.expand() –æ—à–∏–±–∫–∞: ${error.message}</div>`;
                    }
                    
                } catch (error) {
                    html += `<div class="test-result error">‚ùå –û—à–∏–±–∫–∞ Telegram API: ${error.message}</div>`;
                }
            } else {
                html += '<div class="test-result error">‚ùå Telegram Web App API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</div>';
            }
            
            telegramTest.innerHTML = html;
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('–¢–µ—Å—Ç –±–æ—Ç–∞ –∑–∞–ø—É—â–µ–Ω');
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
            setTimeout(() => {
                testInitialization();
                testTelegram();
            }, 1000);
        });
    </script>
</body>
</html>
